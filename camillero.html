<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Camillero - Disponibilidad</title>
    <style>
        :root { --primary: #2c3e50; --success: #28a745; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 15px; }
        .container { max-width: 450px; margin: auto; }
        
        .status-header { 
            background: white; padding: 20px; border-radius: 15px; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px;
        }

        /* Bot√≥n de Disponibilidad */
        .btn-status {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; color: white;
            transition: 0.3s; margin-top: 10px;
        }
        .disponible { background: var(--success); box-shadow: 0 4px 0 #1e7e34; }
        .inactivo { background: var(--danger); box-shadow: 0 4px 0 #bd2130; }

        .card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            border-left: 8px solid #3498db; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            box-sizing: border-box; /* Fix margen */
        }
        .urgente { border-color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { background: #fff; } 50% { background: #fff5f5; } 100% { background: #fff; } }

        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { padding: 5px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; background: #eee; white-space: nowrap; }
        .tag-o2 { background: #d1ecf1; color: #0c5460; }
        .tag-estudio { background: #fff3cd; color: #856404; }

        .btn-finalizar { background: var(--success); color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; margin-top: 15px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-header">
            <div id="reloj" style="font-size: 1.4rem; font-weight: bold;">00:00:00</div>
            <button id="btnToggleStatus" class="btn-status inactivo">INACTIVO</button>
            <p id="labelStatus" style="margin-top: 8px; font-size: 0.9rem; font-weight: bold; color: #666;">Turno fuera de l√≠nea</p>
        </div>

        <div id="listaPedidos"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAaOmAIQ6GorJsSQAiFg-mUpnZJR2ivd4",
            authDomain: "appguardia-8d02b.firebaseapp.com",
            databaseURL: "https://appguardia-8d02b-default-rtdb.firebaseio.com",
            projectId: "appguardia-8d02b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const statusRef = ref(db, 'config/estadoTurno');
        const pedidosRef = ref(db, 'pedidos');

        let isAvailable = false;
        let pedidosActuales = {};

        // Manejo del bot√≥n de Disponibilidad
        const btn = document.getElementById('btnToggleStatus');
        btn.addEventListener('click', () => {
            isAvailable = !isAvailable;
            set(statusRef, isAvailable);
        });

        // Escuchar estado global
        onValue(statusRef, (snapshot) => {
            isAvailable = snapshot.val() || false;
            btn.innerText = isAvailable ? "DISPONIBLE" : "INACTIVO";
            btn.className = `btn-status ${isAvailable ? 'disponible' : 'inactivo'}`;
            document.getElementById('labelStatus').innerText = isAvailable ? "Recibiendo pedidos de este turno" : "Turno cerrado / Fuera de servicio";
            renderizar();
        });

        // Escuchar pedidos
        onValue(pedidosRef, (snapshot) => {
            pedidosActuales = snapshot.val();
            renderizar();
        });

        function renderizar() {
            const listaDiv = document.getElementById('listaPedidos');
            listaDiv.innerHTML = "";
            if (!isAvailable) {
                listaDiv.innerHTML = "<p style='text-align:center; color:gray;'>Debes estar DISPONIBLE para ver pedidos.</p>";
                return;
            }
            if (pedidosActuales) {
                Object.keys(pedidosActuales).forEach(id => {
                    const p = pedidosActuales[id];
                    const card = document.createElement('div');
                    card.className = `card ${p.prioridad === 'rojo' ? 'urgente' : ''}`;
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span>${p.paciente}</span><span>${p.hora} hs</span>
                        </div>
                        <div style="font-size:0.9rem; margin: 5px 0;">DNI: ${p.dni}</div>
                        <div class="tags-container">
                            <span class="tag tag-estudio">${p.estudio}</span>
                            <span class="tag">${p.traslado}</span>
                            ${p.oxigeno === 'SI' ? '<span class="tag tag-o2">üíß O2: S√ç</span>' : ''}
                        </div>
                        <button class="btn-finalizar" onclick="finalizar('${id}')">‚úì FINALIZAR</button>
                    `;
                    listaDiv.appendChild(card);
                });
            }
        }

        window.finalizar = (id) => {
            if(confirm("¬øTraslado finalizado?")) {
                const histRef = ref(db, 'historial');
                push(histRef, {...pedidosActuales[id], timestampServer: serverTimestamp()}).then(() => {
                    remove(ref(db, 'pedidos/' + id));
                });
            }
        };

        setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleTimeString(); }, 1000);
    </script>
</body>
</html>
