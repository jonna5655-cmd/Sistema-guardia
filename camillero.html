<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/822/822143.png">

    <title>Panel Camillero - Gesti√≥n de Turnos</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --urgente: #e74c3c;
            --franquero: #8e44ad;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: auto; }
        
        .header-status { 
            background: var(--primary); color: white; padding: 15px; 
            border-radius: 12px; text-align: center; margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .badge-dia {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 5px;
            background: rgba(255,255,255,0.2);
        }

        .card {
            background: #fff; border-left: 8px solid var(--accent); 
            margin: 15px 0; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .urgente-flash { border: 3px solid var(--urgente) !important; animation: parpadeo 1.5s infinite; }
        @keyframes parpadeo { 0% { background-color: #fff; } 50% { background-color: #ffeaea; } 100% { background-color: #fff; } }

        .tag { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin-right: 5px; border: 1px solid #ddd; }
        .tag-oxigeno { background: #d1ecf1; color: #0c5460; }
        
        .btn-ok {
            background: #28a745; color: white; border: none; padding: 14px; width: 100%;
            border-radius: 8px; margin-top: 15px; font-weight: bold; cursor: pointer;
        }

        /* --- ESTILOS ALERTA FLOTANTE --- */
        .alerta-flotante {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%);
            width: 90%; max-width: 400px; background: #f1c40f; color: #2c3e50;
            padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .alerta-flotante.show { transform: translateX(-50%) translateY(0); }
        .alerta-urgente { background: #e74c3c !important; color: white !important; animation: sacudida 0.5s infinite; }
        @keyframes sacudida {
            0% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-52%) rotate(-1deg); }
            75% { transform: translateX(-48%) rotate(1deg); }
            100% { transform: translateX(-50%) rotate(0deg); }
        }
        .btn-cerrar-alerta {
            margin-top: 15px; background: #2c3e50; color: white; border: none;
            padding: 10px 25px; border-radius: 20px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="popupAlerta" class="alerta-flotante">
        <h3>üö® NUEVO PEDIDO</h3>
        <p id="popPaciente">Paciente: -</p>
        <p id="popEstudio">Estudio: -</p>
        <button class="btn-cerrar-alerta" onclick="cerrarAlerta()">ENTENDIDO</button>
    </div>

    <div class="container">
        <div class="header-status">
            <div id="reloj" style="font-size: 1.2rem; font-weight: bold;">00:00:00</div>
            <div id="fechaActual" style="font-size: 0.9rem; opacity: 0.8;">--/--/--</div>
            <div id="infoTurno" class="badge-dia">Detectando Turno...</div>
        </div>

        <h2 style="color: var(--primary); text-align: center;">‚è∞ Pedidos Activos</h2>
        <div id="listaPedidos">
            <p style="text-align:center; color: #666;">Cargando pedidos...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAaOmAIQ6GorJsSQAiFg-mUpnZJR2ivd4",
            authDomain: "appguardia-8d02b.firebaseapp.com",
            databaseURL: "https://appguardia-8d02b-default-rtdb.firebaseio.com",
            projectId: "appguardia-8d02b",
            storageBucket: "appguardia-8d02b.firebasestorage.app",
            messagingSenderId: "830140146359",
            appId: "1:830140146359:web:dfbac10ec53d7ee76e2332"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const pedidosRef = ref(db, 'pedidos');

        const feriadosArg = ["2025-01-01", "2025-03-03", "2025-03-04", "2025-03-24", "2025-04-02", "2025-04-18", "2025-05-01", "2025-05-25", "2025-06-16", "2025-06-20", "2025-07-09", "2025-08-15", "2025-10-12", "2025-11-20", "2025-12-08", "2025-12-25"];

        // Control de notificaciones
        let pedidosAnterioresIds = new Set();
        let primeraCarga = true;

        function esFranquero() {
            const hoy = new Date();
            const diaSemana = hoy.getDay(); 
            const fechaString = hoy.toISOString().split('T')[0];
            return (diaSemana === 0 || diaSemana === 6 || feriadosArg.includes(fechaString));
        }

        function obtenerTurnoActual() {
            const h = new Date().getHours();
            const esFinde = esFranquero();
            if (esFinde && h >= 7 && h < 21) return "FRANQUERO";
            if (h >= 7 && h < 14) return "MA√ëANA";
            if (h >= 14 && h < 21) return "TARDE";
            return "NOCHE";
        }

        setInterval(() => {
            const ahora = new Date();
            document.getElementById('reloj').innerText = ahora.toLocaleTimeString();
            document.getElementById('fechaActual').innerText = ahora.toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('infoTurno').innerText = "TURNO: " + obtenerTurnoActual();
        }, 1000);

        // Solicitar permisos al inicio
        if ("Notification" in window) {
            Notification.requestPermission();
        }

        onValue(pedidosRef, (snapshot) => {
            const pedidosActuales = snapshot.val();
            const listaDiv = document.getElementById('listaPedidos');
            listaDiv.innerHTML = "";
            const turno = obtenerTurnoActual();
            const nuevosIds = new Set();

            if (pedidosActuales) {
                let hayPedidos = false;
                Object.keys(pedidosActuales).forEach(id => {
                    const p = pedidosActuales[id];
                    nuevosIds.add(id);

                    // L√≥gica de Notificaci√≥n para pedidos nuevos
                    if (!primeraCarga && !pedidosAnterioresIds.has(id)) {
                        enviarNotificacion(p.paciente, p.estudio, p.prioridad);
                    }

                    const hPedido = parseInt(p.hora.split(":")[0]);
                    let mostrar = false;

                    if (turno === "FRANQUERO") { if (hPedido >= 7 && hPedido < 21) mostrar = true; }
                    else if (turno === "MA√ëANA") { if (hPedido >= 7 && hPedido < 14) mostrar = true; }
                    else if (turno === "TARDE") { if (hPedido >= 14 && hPedido < 21) mostrar = true; }
                    else { if (hPedido >= 21 || hPedido < 7) mostrar = true; }

                    if (mostrar) {
                        hayPedidos = true;
                        const esUrgente = p.prioridad === "rojo";
                        const card = document.createElement('div');
                        card.className = `card ${esUrgente ? 'urgente-flash' : ''}`;
                        card.innerHTML = `
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${p.paciente}</strong>
                                <span>${p.hora} hs</span>
                            </div>
                            <p>DNI: ${p.dni}</p>
                            <div style="margin-top:10px;">
                                <span class="tag" style="background:#fff3cd;">${p.estudio || 'Estudio'}</span><br><br>
                                <span class="tag">${p.traslado || 'S/D'}</span>
                                ${p.oxigeno === "SI" ? '<span class="tag tag-oxigeno">üíß O2</span>' : ''} 
                            </div>
                            <button class="btn-ok" onclick="finalizarPedido('${id}')">‚úì FINALIZAR</button>
                        `;
                        listaDiv.appendChild(card);
                    }
                });
                if (!hayPedidos) listaDiv.innerHTML = "<p style='text-align:center;'>‚úÖ Sin traslados en este turno.</p>";
            } else {
                listaDiv.innerHTML = "<p style='text-align:center;'>‚úÖ No hay traslados pendientes.</p>";
            }
            pedidosAnterioresIds = nuevosIds;
            primeraCarga = false;
        });

        function enviarNotificacion(paciente, estudio, prioridad) {
            const esRojo = prioridad === "rojo";
            const pop = document.getElementById('popupAlerta');
            document.getElementById('popPaciente').innerHTML = `<strong>Paciente:</strong> ${paciente}`;
            document.getElementById('popEstudio').innerHTML = `<strong>Estudio:</strong> ${estudio}`;
            
            if (esRojo) {
                pop.classList.add('alerta-urgente');
                pop.querySelector('h3').innerText = "üö® ¬°URGENCIA M√âDICA!";
            } else {
                pop.classList.remove('alerta-urgente');
                pop.querySelector('h3').innerText = "üìã NUEVO PEDIDO";
            }
            pop.classList.add('show');

            if (Notification.permission === "granted") {
                navigator.serviceWorker.ready.then(reg => {
                    reg.showNotification(esRojo ? "üö® URGENCIA" : "üöë NUEVO TRASLADO", {
                        body: `Paciente: ${paciente}\nEstudio: ${estudio}`,
                        icon: "https://cdn-icons-png.flaticon.com/512/822/822143.png",
                        vibrate: [300, 100, 300],
                        tag: "pedido-" + Date.now(),
                        renotify: true
                    });
                });
            }

            const sonido = new Audio(esRojo ? 
                'https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3' : 
                'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'
            );
            sonido.play().catch(() => {});
        }

        window.cerrarAlerta = () => document.getElementById('popupAlerta').classList.remove('show');

        window.finalizarPedido = function(id) {
            if(confirm("¬øConfirmas finalizaci√≥n?")) {
                const historialRef = ref(db, 'historial');
                onValue(ref(db, 'pedidos/' + id), (snap) => {
                    const data = snap.val();
                    if(data) {
                        const registro = { ...data, fechaFinalizado: new Date().toLocaleDateString(), timestampServer: serverTimestamp() };
                        push(historialRef, registro).then(() => remove(ref(db, 'pedidos/' + id)));
                    }
                }, { onlyOnce: true });
            }
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>
